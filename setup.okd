#!/usr/bin/bash

# OKD Python 3.12 setup script for ironic-agent-image
# Install Python 3.12 versions of OpenStack packages via pip for OKD builds

set -euo pipefail

# This script assumes it's called only for OKD builds

echo "Installing Python 3.12 packages for OKD build (ironic-agent)"

# Install OpenStack packages from requirements file
if [[ -f /tmp/python-requirements.okd ]]; then
    echo "Installing OpenStack packages for Python 3.12 via pip"
    
    # Install build dependencies needed for compiling C extensions (e.g., dbus-python)
    # dbus-devel is already in packages-list.okd, python3.12-devel is in Dockerfile
    BUILD_DEPS="gcc gcc-c++ glib2-devel pkgconfig python3.12-wheel"
    dnf install -y python3.12-pip 'python3.12-setuptools >= 64.0.0' $BUILD_DEPS
    
    python3.12 -m pip install --no-cache-dir --prefix /usr -c https://releases.openstack.org/constraints/upper/master -r /tmp/python-requirements.okd
    
    # Compile Python files for better performance
    python3.12 -m compileall --invalidation-mode=timestamp -q /usr
    
    PBR_VERSION=1.0 python3.12 -m pip install --no-build-isolation --no-index --verbose --prefix=/usr /tmp/hardware_manager
    
    # Remove build dependencies to keep image small
    dnf remove -y $BUILD_DEPS
fi

echo "OKD setup completed successfully (ironic-agent)"
